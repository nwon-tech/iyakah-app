<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      defer
      src="/_vercel/insights/script.js"
      onerror="console.error('Insights script failed to load.')"
    ></script>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- general font for the page -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <!-- dancing script font for the header styling -->
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- alamri header -->
    <link
      href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <title>Iyakah - Discover the Truth</title>
    <meta name="description" content="Discover the truth." />
    <!-- main stylesheet -->
    <link rel="stylesheet" href="./styles/styles.css" />

    <!-- fake image -->
    <link rel="stylesheet" href="./styles/news-styles.css" />

    <!-- chatbot styles -->
    <link rel="stylesheet" href="./styles/chatbot.css" />

    <!-- Add autocomplete specific CSS -->
    <style>
      #autocomplete-results {
        position: absolute;
        z-index: 999;
        background: white;
        border: 1px solid #ddd;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 0;
        display: none;
      }

      #autocomplete-results li {
        padding: 8px 12px;
        cursor: pointer;
      }

      #autocomplete-results li:hover {
        background-color: #f7f7f7;
      }

      .media-input-container {
        position: relative;
        width: 100%;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <!-- navbar -->
    <nav class="navbar" id="navbar">
      <div class="nav-logo"><a href="index.html">IYAKAH</a></div>
      <div class="nav-center">
        <ul class="nav-links">
          <li class="nav-item">
            Features
            <ul class="dropdown">
              <li>
                <a href="./website-verification.html"
                  >Website Legitimacy Checker</a
                >
              </li>
              <li>
                <a href="./image-verification.html">Fake Image Detector</a>
              </li>
              <li><a href="./news-verification.html">News Bias Detector</a></li>
            </ul>
          </li>
          <li class="nav-item">
            Education
            <ul class="dropdown">
              <li>
                <a href="./education.html">Materials</a>
              </li>
              <li>
                <a href="./quiz.html">Quiz</a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>

    <!-- news verification  -->
    <main class="container">
      <div class="tab-pane active" id="tab1">
        <h3>News Bias Detector</h3>
        <p id="caption">News bias and AI-generated analysis</p>

        <p id="description">
          Enter news content and we will analyze potential biases, and detect
          whether the article is AI-generated or human-written
        </p>
        <div class="input-options">
          <div class="option-content active" id="text-option">
            <p>Article Text</p>

            <textarea
              id="news-input"
              class="input-field textarea"
              placeholder="Please enter news content"
              required
            ></textarea>

            <p>Support .txt, .doc, .docx formats or directly paste text</p>

            <!-- do not remove, line break purposes -->
            <p></p>

            <p>Media Name (Optional):</p>
            <div class="media-input-container">
              <input
                type="text"
                id="media-input"
                autocomplete="off"
                placeholder="Enter media name here..."
              />
              <ul id="autocomplete-results"></ul>
            </div>
            <div class="button-container">
              <button class="btn btn-primary" id="check-news">Analyse</button>
            </div>

            <!-- result output -->
            <div class="result-container" id="news-result-container"></div>
            <div id="chatbot-result-container"></div>
          </div>
        </div>
      </div>

      <!-- chatbot widget start -->
      <div id="chatbot-container">
        <!-- Chat Bubble -->
        <div id="chatbot-bubble" title="Open Chatbot">
          <span>ðŸ’¬</span>
        </div>

        <!-- window -->
        <div id="chatbot-window">
          <div id="chatbot-header">
            <span>ðŸ¤– Iyakah Chatbot</span>
            <button id="close-chat">âœ–</button>
          </div>
          <div id="chatbot-messages">
            <div
              id="typing-indicator"
              class="message bot"
              style="display: none"
            >
              Thinking
            </div>
          </div>
          <div id="chatbot-input-area">
            <input
              type="text"
              id="chatbot-input"
              placeholder="Type your message..."
            />
            <button id="send-message">âœˆ</button>
          </div>
        </div>
      </div>
      <div id="chatbot-tooltip">Need help? Ask me anything!</div>
      <!-- chatbot widget end -->

      <!-- Next Section Navigation -->
      <div class="next-section-options">
        <div class="next">
          <label>Next</label>
        </div>
        <div class="section-options">
          <span
            >->
            <a href="./website-verification.html"
              >Fake Website Verification</a
            ></span
          >
          <span
            >-> <a href="./image-verification.html">AI Image Detection</a></span
          >
        </div>
      </div>
    </main>
    <!-- footer -->
    <footer class="footer">
      <div class="footer-content">
        <div class="footer-left">
          <p>IYAKAH</p>
          <p>Your one-stop solution to battling misinformation online</p>
        </div>
        <div class="footer-links">
          <div>
            <h4>Features</h4>
            <a href="./website-verification.html">Website Legitimacy Checker</a>
            <a href="./image-verification.html">Fake Image Detector</a>
            <a href="./news-verification.html">News Bias Detector</a>
          </div>
          <div>
            <h4>Education</h4>
            <a href="./education.html">Materials</a>
            <a href="./quiz.html">Quiz</a>
          </div>
          <div>
            <h4>Help & Support</h4>
            <a href="./about.html">About Us</a>
            <a href="./faq.html">FAQ</a>
          </div>
        </div>
      </div>
      <hr />
      <div class="footer-bottom">
        <p>Â© 2025 IYAKAH. All rights reserved.</p>
      </div>
    </footer>

    <!-- Add the missing feather icon script -->
    <script src="https://unpkg.com/feather-icons"></script>
    <script type="module" src="./scripts/chatbot.js"></script>

    <!-- Load the autocomplete data first -->
    <script>
      function displayChatbotResponse(responseText) {
        console.log("Chatbot response:", responseText);
        const container = document.getElementById("chatbot-result-container");
        if (!container) return;

        // Clean and format the response
        let cleanedText = cleanChatResponse(responseText);
        let htmlContent = convertMarkdownToHtml(cleanedText);

        container.innerHTML = `
    <div class="chatbot-card">
      <h3>Chatbot Analysis Summary</h3>
      <div class="chatbot-message">
        ${htmlContent}
      </div>
    </div>
  `;
      }

      function convertMarkdownToHtml(text) {
        // Replace **bold** with <strong>
        text = text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

        // Replace * bullets with <ul><li>...</li></ul>
        const lines = text.split("\n");
        let result = "";
        let inList = false;

        lines.forEach((line) => {
          if (line.trim().startsWith("* ")) {
            if (!inList) {
              result += "<ul>";
              inList = true;
            }
            result += `<li>${line.substring(2)}</li>`;
          } else {
            if (inList) {
              result += "</ul>";
              inList = false;
            }
            if (line.trim()) {
              result += `<p>${line}</p>`;
            } else {
              result += "<br>";
            }
          }
        });

        if (inList) result += "</ul>";

        return result;
      }

      function cleanChatResponse(text) {
        // Remove common emojis (basic version)
        text = text.replace(/[\u{1F600}-\u{1F6FF}\u{2700}-\u{27BF}]/gu, "");

        // Remove extra spaces
        return text.trim();
      }
      // Global variable to store media data
      let mediaItems = [];

      // call user IP
      let userIp = "Unknown";
      let isIpFetched = false;

      // Fetch data.json before other scripts
      fetch("./scripts/data.json")
        .then((response) => {
          if (!response.ok) {
            throw new Error("Failed to load data.json");
          }
          return response.json();
        })
        .then((data) => {
          mediaItems = data;
          console.log("Media data loaded:", mediaItems.length, "items");
        })
        .catch((error) => {
          console.error("Error loading media data:", error);
        });

      // Function to fetch user IP
      const fetchUserIp = async () => {
        try {
          const res = await fetch("https://api.ipify.org?format=json");
          const data = await res.json();
          if (data && data.ip) {
            userIp = data.ip;
            isIpFetched = true;
          } else {
            console.warn("IP not found in response.");
            isIpFetched = true;
          }
        } catch (err) {
          console.error("Could not fetch IP:", err);
          isIpFetched = true;
        }
      };
      // Function to process bias data and create table content
      function processBiasData(data) {
        // Check if bias data exists
        if (
          !data ||
          !data.data ||
          !data.data.textBiasResult ||
          !data.data.textBiasResult.biased_sentences
        ) {
          return '<tr><td colspan="2">No bias data available</td></tr>';
        }

        const biasedSentences = data.data.textBiasResult.biased_sentences;

        // Group sentences by bias type
        const biasByType = {};

        // Process each biased sentence
        biasedSentences.forEach((sentence) => {
          const biasType = sentence.bias_type;

          // Initialize the array for this bias type if it doesn't exist
          if (!biasByType[biasType]) {
            biasByType[biasType] = [];
          }

          // Add this sentence to its bias type group
          biasByType[biasType].push(sentence);
        });

        // For each bias type, find the sentence with highest probability
        const highestProbabilitySentences = {};

        Object.keys(biasByType).forEach((biasType) => {
          // Sort sentences by probability (descending)
          const sortedSentences = biasByType[biasType].sort(
            (a, b) => b.bias_probability - a.bias_probability
          );

          // Get the sentence with highest probability
          highestProbabilitySentences[biasType] = sortedSentences[0];
        });

        // Create table rows for each bias type
        let tableHTML = "";

        // Define descriptions for different bias types
        const biasDescriptions = {
          political:
            "Supporting a particular political view or party while ignoring others.",
          gender:
            "Preferring one gender over another, often seen in language or role assumptions.",
          racial:
            "Stereotyping or favoring certain races or ethnic groups in the content.",
        };

        // Create rows for each bias type found
        Object.keys(highestProbabilitySentences).forEach((biasType) => {
          const sentence = highestProbabilitySentences[biasType];
          const biasDescription =
            biasDescriptions[biasType] || `Bias related to ${biasType}`;
          const probability = Math.floor(sentence.bias_probability * 100);

          tableHTML += `
        <tr>
          <td>${biasType.charAt(0).toUpperCase() + biasType.slice(1)} Bias</td>
          <td>
            <p><strong>${biasDescription}</strong></p>
            <p class="biased-text">Detected Sentence: "${sentence.text}"</p>
            <p class="bias-probability">Confidence: ${probability}%</p>
          </td>
        </tr>
      `;
        });

        return (
          tableHTML || '<tr><td colspan="2">No specific bias detected</td></tr>'
        );
      }

      document.addEventListener("DOMContentLoaded", () => {
        fetchUserIp();

        // Fake News Detector functionality
        const newsInput = document.getElementById("news-input");
        const checkNewsButton = document.getElementById("check-news");
        const mediaInput = document.getElementById("media-input");
        const resultsList = document.getElementById("autocomplete-results");

        // Setup autocomplete functionality
        mediaInput.addEventListener("input", function () {
          const query = this.value.toLowerCase();
          resultsList.innerHTML = "";

          if (query.length === 0) {
            resultsList.style.display = "none";
            return;
          }

          if (!mediaItems || mediaItems.length === 0) {
            console.log("No media items available for autocomplete");
            return;
          }

          const matches = mediaItems
            .filter((item) => item.site_name.toLowerCase().startsWith(query))
            .slice(0, 10); // Limit to 10 suggestions

          if (matches.length > 0) {
            resultsList.style.display = "block";

            matches.forEach((match) => {
              const li = document.createElement("li");
              li.textContent = match.site_name;
              li.addEventListener("click", () => {
                mediaInput.value = match.site_name;
                resultsList.style.display = "none";
              });
              resultsList.appendChild(li);
            });
          } else {
            resultsList.style.display = "none";
          }
        });

        // Hide autocomplete when clicking outside
        document.addEventListener("click", function (event) {
          if (
            !resultsList.contains(event.target) &&
            event.target !== mediaInput
          ) {
            resultsList.style.display = "none";
          }
        });

        // info card for loading animations
        const infoCard = document.getElementById("loading-card");
        const infoMessage = document.getElementById("loading-message");
        const closeBtn = document.getElementById("loading-close-btn");

        // random facts appear everytime the user clicks the button
        // to show the loading animation
        const facts = [
          "Nearly 40% of news shared on social media is shared without being read!",
          "The average person consumes more than 100,000 words per day online.",
          "AI-generated articles are shared 3x more often than human-written ones.",
          "False news spreads 6 times faster on Twitter than true news.",
          "Most users can't distinguish between sponsored content and real articles.",
          "Misinformation is most common during elections and crises.",
        ];

        function showDidYouKnow() {
          const randomIndex = Math.floor(Math.random() * facts.length);
          const selectedFact = facts[randomIndex];

          infoMessage.textContent = selectedFact;
          closeBtn.classList.add("hidden");
          infoCard.classList.remove("hidden");
        }

        function showResultReady() {
          infoMessage.textContent = "The result is ready! Click below to view.";
          closeBtn.textContent = "View Results";
          closeBtn.classList.remove("hidden");
          closeBtn.disabled = false;
        }

        function showErrorState() {
          infoMessage.textContent =
            "An error occurred while fetching your result.";
          closeBtn.textContent = "An Error Has Occurred";
          closeBtn.classList.remove("hidden");
          closeBtn.disabled = true; // Optional: prevent clicking
          closeBtn.classList.add("error");
        }

        function hideInfoCard() {
          infoCard.classList.add("hidden");
          document
            .getElementById("news-result-container")
            ?.scrollIntoView({ behavior: "smooth" });
        }

        closeBtn.addEventListener("click", () => {
          hideInfoCard();
        });

        // Wrap fetch logic in this modular function
        function showLoadingCard(fetchFunction) {
          showDidYouKnow();
          let dotCount = 0;
          const dotStates = [
            "Analysing",
            "Analysing.",
            "Analysing..",
            "Analysing...",
          ];
          let currentMessageIndex = 0;

          const messageStages = [
            { time: 0, text: "Analysing" },
            { time: 5000, text: "Still analysing" },
            { time: 10000, text: "Hang tight, almost there" },
            { time: 15000, text: "This is taking a bit longer than usual..." },
            {
              time: 20000,
              text: "Server is still working on it â€” thanks for your patience!",
            },
            {
              time: 25000,
              text: "We're making sure everything is accurate â€” almost done!",
            },
          ];

          closeBtn.classList.remove("error");
          closeBtn.disabled = true;
          closeBtn.classList.remove("hidden");
          closeBtn.textContent = "Analysing";

          let animationInterval;
          let messageTimers = [];

          // animate dots
          animationInterval = setInterval(() => {
            dotCount = (dotCount + 1) % dotStates.length;
            closeBtn.textContent = dotStates[dotCount];
          }, 500);

          // schedule messages
          messageStages.forEach((stage, i) => {
            const timer = setTimeout(() => {
              currentMessageIndex = i;
            }, stage.time);
            messageTimers.push(timer);
          });

          // update message text
          const messageUpdater = setInterval(() => {
            if (!closeBtn.disabled) return;
            closeBtn.textContent = dotStates[dotCount].replace(
              "Analysing",
              messageStages[currentMessageIndex].text
            );
          }, 500);

          fetchFunction()
            .then(() => {
              clearInterval(animationInterval);
              clearInterval(messageUpdater);
              messageTimers.forEach(clearTimeout);
              showResultReady();
            })
            .catch(() => {
              clearInterval(animationInterval);
              clearInterval(messageUpdater);
              messageTimers.forEach(clearTimeout);
              showErrorState();
            });
        }

        // News verification functionality
        checkNewsButton.addEventListener("click", () => {
          const newsContent = newsInput.value.trim();
          const mediaName = mediaInput.value.trim();

          // Clear the previous results
          const newsesultContainer = document.getElementById(
            "news-result-container"
          );

          if (newsesultContainer) {
            newsesultContainer.innerHTML = "";
          }

          let timeoutId;

          if (!newsContent) {
            alert("Please enter news content to check.");
            return;
          }

          checkNewsButton.disabled = true;
          checkNewsButton.textContent = "Analysing...";

          showLoadingCard(() => {
            return new Promise((resolve, reject) => {
              const formData = JSON.stringify({
                text: newsContent,
                mediaName: mediaName || null,
              });

              // Log the news content for debugging
              console.log("Sending news content to backend:", formData);

              // Send the news content to the Java backend
              fetch(
                "https://www.pollucheck8.com:8088/analysislog/addAnalysisLogByNews",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: formData,
                }
              )
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Failed to check news legitimacy");
                  }
                  return response.json();
                })
                .then((data) => {
                  console.log("Response from backend:", data);

                  var newsResultSummary =
                    data.data.resultSummary || "No result available";
                  var newsConfidenceScore =
                    data.data.confidenceScore || "No score available";
                  var newsMediaBiasRating =
                    data.data.mediaBiasRating || "No rating available";
                  var newsMediamediaBiasScore =
                    data.data.mediaBiasScore || "No score available";

                  // for textBiasResult Section
                  var newsBiasScore =
                    data.data.textBiasScore || "No data available";

                  var newsBiasType =
                    data.data.textBiasResult?.document_analysis.bias_type ||
                    "No data available";

                  // show sentences for bias analysis
                  var newsBiasSentences =
                    data.data.textBiasResult.biased_sentences.text ||
                    "No data available";

                  // formatting output
                  if (newsResultSummary.toLowerCase() === "AI-generated") {
                    newsResultSummary = "Ai-Generated";
                  } else {
                    newsResultSummary = "Human-written";
                  }

                  var imgRating = "";

                  if (newsResultSummary === "Ai-Generated") {
                    imgRating =
                      "./scripts/news-detection-results/news-unsafe-icon.png";
                  } else {
                    imgRating =
                      "./scripts/news-detection-results/news-safe-icon.png";
                  }

                  // floor the number
                  newsConfidenceScore = Math.floor(newsConfidenceScore);
                  newsBiasScore = Math.floor(newsBiasScore);

                  // bias portrait
                  const imgBias =
                    "./scripts/news-detection-results/news-bias-icon.png";

                  // media bias potrait
                  const imgMediaBias =
                    "./scripts/news-detection-results/news-media-icon.png";

                  // Display the data on the index.html page

                  const newsResultContainer = document.getElementById(
                    "news-result-container"
                  );
                  if (newsResultContainer) {
                    // Process the bias data to create table rows
                    const biasTableRows = processBiasData(data);

                    newsResultContainer.innerHTML = `
                  <div class="info-container">
                      <div class="info-card">
                        <div class="info-icon">
                          <img src="${imgRating}" alt="${newsResultSummary}" style="max-width: 100%; max-height: 200px; margin-bottom: 1rem;">
                          <span class="label">${newsResultSummary}</span>
                        </div>
                        <div class="info-value">${newsConfidenceScore}%</div>
                      </div>

                      <div class="info-card">
                        <div class="info-icon">
                          <img src="${imgBias}" alt="${newsResultSummary}" style="max-width: 100%; max-height: 200px; margin-bottom: 1rem;">
                          <span class="label">${
                            newsBiasType.charAt(0).toUpperCase() +
                            newsBiasType.slice(1)
                          } Bias</span>
                        </div>
                        <div class="info-value">${newsBiasScore}%</div>
                      </div>

                      <div class="info-card">
                        <div class="info-icon">
                          <img src="${imgMediaBias}" alt="${newsMediaBiasRating}" style="max-width: 100%; max-height: 200px; margin-bottom: 1rem;">
                          <span class="label">${newsMediaBiasRating}</span>
                        </div>
                      </div>

                    </div>

                    <p>All detection results are for informational purposes only and do not constitute professional or legal advice.</p>

                    <h2> Bias Analysis Report</h2>
                    <table>
                      <colgroup>
                        <col style="width: 30%" />
                        <col style="width: 70%" />
                      </colgroup>

                      <tbody>
                        ${biasTableRows}
                      </tbody>
                    </table>

                    <p>All detection results are for informational purposes only and do not constitute professional or legal advice.</p>

                  `;
                  }

                  // chatbot response
                  if (data.data.chatResponse) {
                    displayChatbotResponse(data.data.chatResponse);
                  }

                  // Re-enable the button
                  checkNewsButton.disabled = false;
                  checkNewsButton.textContent = "Analyse";
                  resolve();
                })
                .catch((error) => {
                  // hideSpinner(timeoutId);
                  checkNewsButton.disabled = false;
                  checkNewsButton.textContent = "Analyse";
                  alert("Error checking news. Please try again.");
                  console.error(error);
                  reject();
                });
            });
          });
        });
      });
    </script>
    <script type="module" src="middleware.js"></script>
    <!-- info card during loading animation -->
    <div id="loading-card" class="loading-card hidden">
      <div class="loading-card-content">
        <img
          src="./styles/media/lightbulb.svg"
          alt="Did you know?"
          class="loading-image"
        />
        <div class="loading-text">
          <h3>Did you know?</h3>
          <p id="loading-message">
            Nearly 40% of news shared on social media is shared without being
            read!
          </p>
          <!-- this button is dynamically updated to -->
          <button id="loading-close-btn" class="loading-close-btn hidden">
            Start
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
